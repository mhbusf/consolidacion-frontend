<div class="container">
  <button class="btn-back" (click)="volver()">
    ‚Üê Volver
  </button>

  <div *ngIf="isLoading" class="loading">
    Cargando informaci√≥n...
  </div>

  <div *ngIf="!isLoading && consolidado">
    <div class="detail-card">
      <div class="card-header">
        <h2>{{ consolidado.nombre }}</h2>
        <div class="badges">
           <span class="badge" *ngIf="consolidado.usuarioAsignado">
            Asignado a: {{ consolidado.usuarioAsignado }}
          </span>
          <span class="badge badge-warning" *ngIf="!consolidado.usuarioAsignado">
            Sin asignar
          </span>
          <span class="badge badge-success" *ngIf="consolidado.estado === 'GDC'">
            ‚úÖ Con GDC: {{ consolidado.gdc }}
          </span>
        </div>
      </div>

      <div class="card-body">
        <div class="info-grid">
          <div class="info-item">
            <strong>Tel√©fono:</strong>
            <span>{{ consolidado.telefono }}</span>
          </div>
          <div class="info-item">
            <strong>Edad:</strong>
            <span>{{ consolidado.edad }} a√±os</span>
          </div>
          <div class="info-item">
            <strong>Comuna:</strong>
            <span *ngIf="consolidado.comuna">
              {{ consolidado.comuna.nombre }}
            </span>
            <span *ngIf="!consolidado.comuna" class="text-muted">
              No especificada
            </span>
          </div>
          <div class="info-item">
            <strong>Invitado por:</strong>
            <span>{{ consolidado.quienInvito }}</span>
          </div>
          <div class="info-item">
            <strong>Reportado por:</strong>
            <span *ngIf="consolidado.usuarioReporta">{{ consolidado.usuarioReporta }}</span>
            <span *ngIf="!consolidado.usuarioReporta" class="text-muted">No especificado</span>
          </div>
        </div>

        <div class="info-section">
          <strong>Motivo de Oraci√≥n:</strong>
          <p>{{ consolidado.motivoOracion }}</p>
        </div>

        <!-- Bot√≥n para cerrar con GDC (solo ADMIN) -->
        <div class="actions-section" *ngIf="puedeSerCerrado()">
          <button class="btn-gdc" (click)="abrirModalGDC()">
            üìù Cerrar con GDC
          </button>
        </div>
      </div>
    </div>

    <div class="comentarios-section">
      <h3>Comentarios y Seguimiento</h3>

      <div class="comentario-form">
        <textarea 
          [(ngModel)]="nuevoComentario"
          placeholder="Escribe un comentario de seguimiento..."
          rows="3"
          class="form-control"></textarea>
        <button 
          class="btn-primary" 
          (click)="agregarComentario()"
          [disabled]="!nuevoComentario.trim() || isLoadingComentario">
          {{ isLoadingComentario ? 'Guardando...' : 'Agregar Comentario' }}
        </button>
      </div>

      <div class="comentarios-list">
        <div class="empty-state" *ngIf="comentarios.length === 0">
          No hay comentarios a√∫n. ¬°S√© el primero en comentar!
        </div>

        <div class="comentario" *ngFor="let com of comentarios">
          <div class="comentario-header">
            <strong>{{ com.username }}</strong>
            <span class="fecha">{{ com.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <p class="comentario-contenido">{{ com.contenido }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para cerrar con GDC -->
<div class="modal-overlay" *ngIf="mostrarModalGDC" (click)="cerrarModalGDC()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>üìù Cerrar Consolidado con GDC</h3>
      <button class="btn-close" (click)="cerrarModalGDC()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="gdcNumero">N√∫mero de GDC *</label>
        <input 
          type="text" 
          id="gdcNumero"
          [(ngModel)]="gdcNumero"
          class="form-control"
          placeholder="Ej: Juan P√©rez"
          [disabled]="isClosing">
      </div>

      <div class="form-group">
        <label for="comentarioCierre">Comentario de Cierre *</label>
        <textarea 
          id="comentarioCierre"
          [(ngModel)]="comentarioCierre"
          class="form-control"
          rows="4"
          placeholder="Escribe el comentario final del proceso..."
          [disabled]="isClosing"></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secon dary" (click)="cerrarModalGDC()" [disabled]="isClosing">
        Cancelar
      </button>
      <button 
        class="btn-success" 
        (click)="cerrarConGDC()"
        [disabled]="!gdcNumero.trim() || !comentarioCierre.trim() || isClosing">
        {{ isClosing ? 'Cerrando...' : '‚úÖ Cerrar con GDC' }}
      </button>
    </div>
  </div>
</div>